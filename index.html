<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹å· 2026 | æ‰‹å¸³ V44 (Shared)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- å¼•å…¥ Firebase SDK for Realtime Shared Plan -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: { bg: '#FFFDF5', dark: '#5C4033', card: '#FFFFFF', pill: '#EAE6D9' },
                        m: { spot: '#E3C16F', food: '#D48C7D', cafe: '#A98467', transport: '#8EA4B5', hotel: '#8E8899', other: '#A3AD8C' }
                    },
                    fontFamily: {
                        hand: ['"Patrick Hand"', 'cursive'],
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'sticker': '3px 3px 0px rgba(92, 64, 51, 0.1)',
                        'cute': '0 4px 10px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Base Layout --- */
        body { 
            background-color: #FFFDF5; 
            color: #5C4033; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background-image: radial-gradient(#DCCEB5 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- Decoration --- */
        .cute-sticker { position: fixed; z-index: 0; pointer-events: none; filter: drop-shadow(0px 0px 3px white) drop-shadow(0px 0px 3px white) drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); opacity: 0.6; }
        .cute-sticker i { font-size: 2rem; }

        /* --- Components --- */
        .hard-card { background: #FFFFFF; border: 2px solid #FFFFFF; border-radius: 1.5rem; box-shadow: 4px 4px 0px rgba(92, 64, 51, 0.08); transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: visible; z-index: 1; }
        .hard-card:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(92, 64, 51, 0.08); }

        .date-btn-active { background-color: transparent; color: #5C4033; font-weight: bold; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10,50 Q20,5 50,10 T90,50 T50,90 T10,50' fill='none' stroke='%23E3C16F' stroke-width='5' stroke-linecap='round' stroke-dasharray='300' stroke-dashoffset='0'/%3E%3C/svg%3E"); background-size: cover; transform: scale(1.1); }

        .ticket-container { position: relative; margin-bottom: 1.5rem; filter: drop-shadow(3px 3px 0px rgba(92, 64, 51, 0.08)); transition: transform 0.1s; z-index: 1; }
        .ticket-container:active { transform: scale(0.98); }
        .ticket-wrap { display: flex; height: auto; min-height: 110px; background: #FFFFFF; border-radius: 16px; overflow: hidden; position: relative; -webkit-mask-image: radial-gradient(circle at 28% 0, transparent 8px, black 8.5px), radial-gradient(circle at 28% 100%, transparent 8px, black 8.5px); mask-image: radial-gradient(circle at 28% 0, transparent 8px, black 8.5px), radial-gradient(circle at 28% 100%, transparent 8px, black 8.5px); -webkit-mask-composite: source-in; }
        .ticket-stub { width: 28%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border-right: 2px dashed rgba(255,255,255,0.6); padding: 10px 5px; text-align: center; }
        .ticket-body { flex: 1; padding: 14px 16px; display: flex; flex-direction: column; justify-content: center; position: relative; background: #FFFFFF; }
        .ticket-details { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s ease-in-out; margin-top: 0; }
        .expanded .ticket-details { max-height: 500px; opacity: 1; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }

        .stub-bg-SPOT { background-color: #FDF6E3; color: #8D7B4B; } .stub-bg-FOOD { background-color: #FCE8E6; color: #A85A4E; } .stub-bg-CAFE { background-color: #F0EAD6; color: #8B6B4E; } .stub-bg-TRANSPORT { background-color: #EBF2F5; color: #5B7B8C; } .stub-bg-HOTEL { background-color: #F2F0F5; color: #6D6875; } .stub-bg-OTHER { background-color: #F1F3EA; color: #7A8568; }

        .washi-tape { pointer-events: none; position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(-1deg); width: 60px; height: 18px; opacity: 0.7; z-index: 10; mask-image: url("data:image/svg+xml,%3Csvg width='100' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 5 Q 5 0, 10 5 T 20 5 T 30 5 T 40 5 T 50 5 T 60 5 T 70 5 T 80 5 T 90 5 T 100 5 V 15 Q 95 20, 90 15 T 80 15 T 70 15 T 60 15 T 50 15 T 40 15 T 30 15 T 20 15 T 10 15 T 0 15 Z' fill='black'/%3E%3C/svg%3E"); -webkit-mask-size: cover; }
        .washi-tape-top { pointer-events: none; top: -10px; left: 45%; width: 60px; height: 20px; transform: rotate(-2deg); background-color: rgba(220, 200, 150, 0.5); position: absolute; z-index: 10; mask-image: url("data:image/svg+xml,%3Csvg width='100' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 5 Q 5 0, 10 5 T 20 5 T 30 5 T 40 5 T 50 5 T 60 5 T 70 5 T 80 5 T 90 5 T 100 5 V 15 Q 95 20, 90 15 T 80 15 T 70 15 T 60 15 T 50 15 T 40 15 T 30 15 T 20 15 T 10 15 T 0 15 Z' fill='black'/%3E%3C/svg%3E"); -webkit-mask-size: cover; }

        .glass-panel { background: #FFFDF5; border-bottom: 1px solid rgba(92, 64, 51, 0.1); }
        .glass-nav { background: rgba(92, 64, 51, 0.98); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }
        .nav-btn.active { color: #FFFFFF; transform: scale(1.1); }
        .nav-btn { color: rgba(255,255,255,0.5); transition: all 0.3s; }
        
        .bottom-sheet { transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); touch-action: none; border-radius: 24px 24px 0 0; }
        .safe-pb { padding-bottom: calc(6rem + env(safe-area-inset-bottom)); }
        .nav-safe { bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        #date-section { transition: all 0.3s ease; overflow: hidden; max-height: 100px; }
        #date-section.hidden-dates { max-height: 0; opacity: 0; padding: 0; }
        .input-polish { transition: all 0.2s; border: 2px solid #EAE6D9; background: #FFFCF8; border-radius: 16px; }
        .input-polish:focus { background: white; border-color: #D9C378; box-shadow: 2px 2px 0px rgba(217, 195, 120, 0.2); }
        .drag-handle { cursor: grab; padding: 10px; color: #D6CFC0; }
        .sortable-ghost { opacity: 0.4; }
        .sortable-drag .hard-card, .sortable-drag .ticket-container { transform: rotate(2deg) scale(1.02); z-index: 50; }
        .polaroid { background: white; padding: 6px 6px 30px 6px; box-shadow: 3px 3px 0px rgba(92, 64, 51, 0.08); transform: rotate(-2deg); border: 1px solid #eee; transition: all 0.2s; }
        
        .add-ticket { border: 2px dashed #D6CFC0; background: #F9F9F9; border-radius: 16px; display: flex; align-items: center; justify-content: center; height: 80px; cursor: pointer; color: #A3AD8C; transition: all 0.2s; margin: 0 1rem 6rem 1rem; }
        .add-voucher-card { border: 2px dashed #D6CFC0; background: #F9F9F9; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #A3AD8C; transition: all 0.2s; min-height: 180px; }
        
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .pie-hole { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 55%; height: 55%; background: #FFFDF5; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .note-card { background-color: #FFFFFF; background-image: linear-gradient(#E8E6E1 1px, transparent 1px), linear-gradient(90deg, #E8E6E1 1px, transparent 1px); background-size: 20px 20px; background-position: center 2px; }
        
        .font-cute { font-family: 'Patrick Hand', cursive; }
        
        /* Stamp Style */
        .stamp-mark {
            position: absolute; top: 50%; left: 70%; 
            transform: translate(-50%, -50%) rotate(-15deg) scale(1.2);
            width: 90px; height: 90px;
            border: 4px double #D32F2F; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #D32F2F; font-family: 'Noto Serif TC', serif; font-weight: 900;
            opacity: 0; z-index: 50; pointer-events: none;
            mix-blend-mode: multiply;
            background: rgba(211, 47, 47, 0.05);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.1) inset;
        }
        .stamp-mark span:first-child { font-size: 2.2rem; line-height: 1; }
        .stamp-mark span:last-child { font-size: 0.6rem; letter-spacing: 2px; border-top: 1px solid #D32F2F; margin-top: 2px; padding-top: 2px; font-family: sans-serif; }
        
        .stamp-animate { animation: stamp-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .stamp-visible { opacity: 0.8; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
        
        @keyframes stamp-slam {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(3) rotate(10deg); }
            50% { opacity: 1; }
            100% { opacity: 0.85; transform: translate(-50%, -50%) scale(1) rotate(-15deg); }
        }

        .ticket-completed .ticket-body { opacity: 0.5; filter: grayscale(80%); transition: all 0.5s; }
        .ticket-completed .ticket-stub { filter: grayscale(80%); transition: all 0.5s; }

        /* Guide & Highlight */
        .btn-guide { background: linear-gradient(135deg, #FDE68A 0%, #FCA5A5 100%); color: #4A3E38; font-weight: bold; box-shadow: 0 2px 5px rgba(252, 165, 165, 0.4); transition: all 0.2s; border-radius: 12px; }
        .hl-food { background-color: #FEE2E2; color: #B91C1C; padding: 0 4px; border-radius: 4px; font-weight: bold; border-bottom: 2px solid #FECACA; }
        .hl-buy { background-color: #DCFCE7; color: #15803D; padding: 0 4px; border-radius: 4px; font-weight: bold; border-bottom: 2px solid #BBF7D0; }
        .hl-code { background-color: #DBEAFE; color: #1E40AF; padding: 0 4px; border-radius: 4px; font-family: 'Patrick Hand', cursive; font-weight: bold; border: 1px dashed #93C5FD; font-size: 1.1em; }
        
        .map-filter-chip { transition: all 0.2s; }
        .map-filter-chip.active { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: transparent; color: white; }
        #day-grid-overlay { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .budget-bar-container { height: 1.5rem; background: #E6E2D6; border-radius: 99px; overflow: hidden; position: relative; border: 2px solid #FFF; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .budget-fill { height: 100%; transition: width 0.5s ease-out; background-size: 20px 20px; background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent); animation: progress-stripes 2s linear infinite; }
        @keyframes progress-stripes { from { background-position: 20px 0; } to { background-position: 0 0; } }
        
        .rotate-v-1 { transform: rotate(1deg); } .rotate-v-2 { transform: rotate(-1.5deg); } .rotate-v-3 { transform: rotate(0.5deg); }
        
        /* Guide Modal Styles */
        #guide-modal { z-index: 60; }
        .prose p { margin-bottom: 1em; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden bg-theme-bg">

    <header class="sticky top-0 z-30 glass-panel transition-all duration-300" id="main-header">
        <div id="banner-section" class="header-container shadow-sm">
            <!-- åœ–ç‰‡æºå·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„ç¶²å€ -->
            <img src="https://i.postimg.cc/D0Y9jDW7/header.png" class="header-img" alt="Kyushu 2026" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'w-full h-full bg-stone-200 flex items-center justify-center text-stone-400 font-serif italic text-lg\'>Header Image</div>'">
            <div class="absolute inset-0 bg-gradient-to-t from-theme-bg/30 to-transparent"></div>
        </div>
        <div id="date-section" class="pt-2 pb-2 border-t border-white/40 flex items-center px-4">
            <div class="flex-1 overflow-x-auto no-scrollbar flex gap-3 snap-x pr-4" id="date-scroll"></div>
            <!-- Share Image Button -->
            <button onclick="shareItinerary()" class="shrink-0 w-10 h-10 rounded-xl bg-theme-dark text-white border border-white/20 flex items-center justify-center active:scale-95 transition-transform mr-2 shadow-sm" title="åŒ¯å‡ºè¡Œç¨‹åœ–">
                <i class="fa-solid fa-share-nodes"></i>
            </button>
            <button onclick="toggleDayGrid()" class="shrink-0 w-10 h-10 rounded-xl bg-white/60 border border-white flex items-center justify-center text-theme-dark active:scale-95 transition-transform"><i class="fa-solid fa-table-cells"></i></button>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar safe-pb bg-theme-bg relative p-2">
    </main>
    
    <div id="sticker-layer" class="fixed inset-0 pointer-events-none overflow-hidden z-0"></div>

    <div id="day-grid-overlay" class="fixed inset-0 z-50 bg-theme-bg/90 hidden flex flex-col pt-20 px-6 pb-6 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-serif text-2xl font-bold text-theme-dark">å¿«é€Ÿè·³è½‰</h2>
            <button onclick="toggleDayGrid()" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-theme-dark shadow-sm"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="day-grid-content" class="grid grid-cols-2 gap-4 overflow-y-auto pb-20"></div>
    </div>

    <!-- Guide Modal (Magazine Style) -->
    <div id="guide-modal" class="fixed inset-0 bg-theme-bg hidden flex-col animate-fade-in overflow-hidden">
        <!-- Close Btn -->
        <button onclick="closeGuide()" class="absolute top-4 right-4 z-20 w-10 h-10 rounded-full bg-black/20 text-white backdrop-blur flex items-center justify-center hover:bg-black/40 transition-colors"><i class="fa-solid fa-xmark"></i></button>
        
        <!-- Hero Image -->
        <div class="h-[40vh] w-full relative shrink-0">
            <img id="guide-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-theme-bg to-transparent"></div>
            <h2 id="guide-title" class="absolute bottom-4 left-6 right-6 text-4xl font-serif font-bold text-theme-dark drop-shadow-sm leading-tight">Title</h2>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 pt-0 no-scrollbar">
            <div class="flex items-center gap-2 mb-6 text-m-spot text-xs font-bold tracking-widest uppercase">
                <span><i class="fa-solid fa-star"></i> Featured Spot</span>
                <span class="w-10 h-[1px] bg-m-spot"></span>
            </div>

            <div class="prose prose-sm prose-stone font-serif leading-relaxed text-theme-dark/80 text-justify">
                <p id="guide-desc" class="first-letter:text-5xl first-letter:font-bold first-letter:float-left first-letter:mr-3 first-letter:text-m-spot">
                    <!-- Content goes here -->
                </p>
            </div>

            <!-- Embedded Map -->
            <div class="mt-8 mb-4">
                 <h4 class="font-bold text-theme-dark mb-2 border-l-4 border-m-spot pl-2 text-sm">Location</h4>
                 <div id="guide-map" class="w-full h-48 bg-gray-200 rounded-xl overflow-hidden relative shadow-inner border border-white">
                    <iframe id="guide-map-frame" width="100%" height="100%" frameborder="0" scrolling="no"></iframe>
                 </div>
            </div>
            
             <!-- Google Search Link -->
             <a id="guide-link" href="#" target="_blank" class="block w-full py-3 mt-6 mb-10 text-center border border-theme-dark/20 rounded-full text-theme-dark/60 text-xs hover:bg-theme-dark hover:text-white transition-colors font-bold tracking-widest uppercase">
                <i class="fa-brands fa-google mr-1"></i> More Info
             </a>
        </div>
    </div>

    <button onclick="handleFabClick()" id="fab-add" class="fixed bottom-24 right-6 w-14 h-14 bg-theme-dark text-white rounded-full shadow-lg flex items-center justify-center text-xl z-30 nav-safe border-2 border-white/20 active:scale-90 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <nav class="fixed nav-safe left-4 right-4 glass-nav h-[72px] rounded-[2rem] shadow-sticker z-40 flex justify-between items-center px-6 border border-white/10">
        <button onclick="router('home')" class="nav-btn flex flex-col items-center gap-1 w-1/5" data-target="home"><i class="fa-solid fa-house text-lg"></i><span class="text-[9px] tracking-wide font-medium">é¦–é </span></button>
        <button onclick="router('plan')" class="nav-btn flex flex-col items-center gap-1 w-1/5" data-target="plan"><i class="fa-solid fa-ticket text-lg"></i><span class="text-[9px] tracking-wide font-medium">è¡Œç¨‹</span></button>
        <button onclick="router('map')" class="nav-btn flex flex-col items-center gap-1 w-1/5" data-target="map"><i class="fa-solid fa-map text-lg"></i><span class="text-[9px] tracking-wide font-medium">åœ°åœ–</span></button>
        <button onclick="router('info')" class="nav-btn flex flex-col items-center gap-1 w-1/5" data-target="info"><i class="fa-solid fa-folder-open text-lg"></i><span class="text-[9px] tracking-wide font-medium">æ†‘è­‰</span></button>
        <button onclick="router('wallet')" class="nav-btn flex flex-col items-center gap-1 w-1/5" data-target="wallet"><i class="fa-solid fa-wallet text-lg"></i><span class="text-[9px] tracking-wide font-medium">è¨˜å¸³</span></button>
    </nav>

    <div id="sheet-overlay" class="fixed inset-0 bg-theme-dark/20 backdrop-blur-[2px] z-50 hidden opacity-0 transition-opacity duration-300" onclick="closeSheet()"></div>
    <div id="edit-sheet" class="fixed bottom-0 left-0 w-full bg-[#FFF] z-50 transform translate-y-full bottom-sheet flex flex-col max-h-[92vh] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] safe-pb border-t border-theme-pill">
        <div id="sheet-handle" class="w-full h-12 flex items-center justify-center cursor-grab active:cursor-grabbing touch-none bg-transparent">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>
        <div id="sheet-content" class="px-6 pb-6 overflow-y-auto space-y-5"></div>
    </div>
    
    <input type="file" id="restore-file" accept=".json" class="hidden" onchange="performRestore(this)">

    <script>
        // --- Utilities ---
        const vibrate = () => { if(navigator.vibrate) navigator.vibrate(5); };
        const getRotate = (id) => { const rots = ['rotate-1', '-rotate-1', 'rotate-2', '-rotate-2', '']; return rots[id % rots.length]; };
        let scrollPositions = {};
        let mapInstance = null;
        let mapFilters = null;

        const DB_KEY = 'kyushu_v43_guide_fix'; // This will no longer be used for primary storage
        const START_DATE = new Date('2026-01-14');
        const CATEGORIES = {
            'SPOT':      { name: 'æ™¯é»', color: 'stub-bg-SPOT', text: 'text-theme-dark', icon: 'fa-camera', tape: 'rgba(217, 195, 120, 0.4)' },
            'FOOD':      { name: 'ç¾é£Ÿ', color: 'stub-bg-FOOD', text: 'text-theme-dark', icon: 'fa-utensils', tape: 'rgba(201, 136, 120, 0.4)' },
            'CAFE':      { name: 'å’–å•¡', color: 'stub-bg-CAFE', text: 'text-theme-dark', icon: 'fa-mug-hot', tape: 'rgba(169, 132, 103, 0.4)' },
            'TRANSPORT': { name: 'äº¤é€š', color: 'stub-bg-TRANSPORT', text: 'text-theme-dark', icon: 'fa-train-subway', tape: 'rgba(142, 164, 181, 0.4)' },
            'HOTEL':     { name: 'ä½å®¿', color: 'stub-bg-HOTEL', text: 'text-theme-dark', icon: 'fa-bed', tape: 'rgba(109, 104, 117, 0.4)' },
            'OTHER':     { name: 'å…¶ä»–', color: 'stub-bg-OTHER', text: 'text-theme-dark', icon: 'fa-flag', tape: 'rgba(158, 168, 128, 0.4)' }
        };
        const FILTER_OPTIONS = [
            { key: 'SPOT', label: 'ğŸ“¸ æ™¯é»', color: 'bg-m-spot' },
            { key: 'FOOD', label: 'ğŸ´ ç¾é£Ÿ', color: 'bg-m-food' },
            { key: 'CAFE', label: 'â˜• å’–å•¡', color: 'bg-m-cafe' },
            { key: 'TRANSPORT', label: 'ğŸš„ äº¤é€š', color: 'bg-m-transport' },
            { key: 'HOTEL', label: 'ğŸ›ï¸ ä½å®¿', color: 'bg-m-hotel' },
        ];
        const VOUCHER_CATS = {
            'HOTEL': { name: 'ä½å®¿', color: 'bg-m-hotel', tape: 'rgba(109, 104, 117, 0.5)', icon: 'fa-bed' },
            'TRANSPORT': { name: 'äº¤é€š', color: 'bg-m-transport', tape: 'rgba(142, 164, 181, 0.5)', icon: 'fa-train-subway' },
            'FOOD': { name: 'é¤å»³', color: 'bg-m-food', tape: 'rgba(201, 136, 120, 0.5)', icon: 'fa-utensils' },
            'OTHER': { name: 'å…¶ä»–', color: 'bg-m-other', tape: 'rgba(158, 168, 128, 0.5)', icon: 'fa-ticket' }
        };
        const WEATHER_DATA = { 'Fukuoka': { current: { temp: 8, h: 12, l: 5, cond: 'Partly Cloudy' }, forecast: [ { d: '1/14', i: 'fa-cloud-sun', h: 9, l: 4 }, { d: '1/15', i: 'fa-sun', h: 11, l: 3 }, { d: '1/16', i: 'fa-cloud-rain', h: 8, l: 5 }, { d: '1/17', i: 'fa-cloud', h: 7, l: 2 }, { d: '1/18', i: 'fa-snowflake', h: 4, l: 0 } ] }, 'Kumamoto': { current: { temp: 6, h: 10, l: 2, cond: 'Sunny' }, forecast: [ { d: '1/14', i: 'fa-sun', h: 10, l: 2 }, { d: '1/15', i: 'fa-sun', h: 12, l: 3 }, { d: '1/16', i: 'fa-cloud-sun', h: 9, l: 4 }, { d: '1/17', i: 'fa-cloud', h: 8, l: 3 }, { d: '1/18', i: 'fa-cloud-rain', h: 6, l: 2 } ] } };

        let appData = { currentDay: 1, rate: 0.22, isLiveRate: false, weatherCity: 'Fukuoka', itinerary: [], expenses: [], shopping: [], vouchers: [], note: {text: '', img: null}, widgetsOrder: ['countdown', 'weather', 'calc', 'shop', 'note'], budget: 150000 };
        let currentView = 'plan'; // Default to plan view on initial load

        // --- Firebase Configuration and Initialization ---
        // **YOUR_FIREBASE_CONFIG** - Using the data from the screenshot
        const firebaseConfig = {
            apiKey: "AIzaSyCf5oVGCiQibf8RkZLCXbXcigHXpIbLFQM",
            authDomain: "fuk2026-e0563.firebaseapp.com",
            projectId: "fuk2026-e0563",
            storageBucket: "fuk2026-e0563.appspot.com",
            messagingSenderId: "90614270826",
            appId: "1:90614270826:web:650e7b13dd785b1d06b313",
            measurementId: "G-LCDDWYNQXG"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // **å…±ç”¨è¡Œç¨‹çš„å”¯ä¸€ ID** - æ‰€æœ‰äººå…±åŒç·¨è¼¯é€™å€‹æ–‡ä»¶
        const TRIP_ID = 'kyushu_2026_shared_plan_A'; 
        const TRIP_DOC_REF = db.collection("plans").doc(TRIP_ID);
        // ----------------------------------------------------


        // --- Core Functions (FIXED DEFINITIONS) ---

        // FIX: Re-added missing fetchLiveRate definition
        async function fetchLiveRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                if(!res.ok) throw new Error('API Error');
                const data = await res.json();
                if(data && data.rates && data.rates.TWD) {
                    if(appData.isLiveRate !== false) {
                        appData.rate = data.rates.TWD; 
                        appData.isLiveRate = true; 
                        saveData(true); 
                    }
                }
            } catch(e) { 
                console.log('Rate fetch failed:', e); 
            }
        }

        // FIX: Re-added missing shareItinerary definition
        function shareItinerary() {
            const el = document.getElementById('plan-list');
            if(!el || el.children.length === 0) { Swal.fire('æç¤º', 'ä»Šå¤©æ²’æœ‰è¡Œç¨‹å¯ä»¥åŒ¯å‡ºå“¦ï¼', 'info'); return; }
            const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
            toast.fire({ icon: 'success', title: 'æ­£åœ¨ç”Ÿæˆç¾åœ–...' });
            html2canvas(el, { backgroundColor: '#FFFDF5', scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); 
                link.download = `Day${appData.currentDay}_Itinerary.png`; 
                link.href = canvas.toDataURL(); 
                link.click();
            }).catch(err => { 
                console.error(err); 
                Swal.fire('åŒ¯å‡ºå¤±æ•—', 'ç”Ÿæˆåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
            });
        }
        
        // FIX: Re-added missing locateMe definition
        function locateMe() {
            if(!mapInstance) return;
            if(!navigator.geolocation) { Swal.fire('éŒ¯èª¤', 'ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'error'); return; }
            const toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 2000 });
            toast.fire({ icon: 'info', title: 'æ­£åœ¨å®šä½ä¸­...' });
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude} = pos.coords;
                mapInstance.setView([latitude, longitude], 15);
                L.marker([latitude, longitude], {icon: L.divIcon({className: 'my-loc', html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-md relative"><div class="absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-75"></div></div>', iconSize: [16,16]})}).addTo(mapInstance).bindPopup("ç›®å‰ä½ç½®").openPopup();
            }, err => { Swal.fire('ç„¡æ³•å®šä½', 'è«‹ç¢ºèªå·²é–‹å•Ÿ GPS æ¬Šé™', 'error'); });
        }
        
        // NEW: åœ–ç‰‡å…¨è¢å¹•æª¢è¦–å‡½å¼
        function showImageFullscreen(imageUrl) {
            Swal.fire({
                title: 'åœ–ç‰‡é è¦½',
                html: `<img src="${imageUrl}" style="width: 100%; height: auto; object-fit: contain; border-radius: 12px;" alt="å…¨è¢å¹•åœ–ç‰‡">`,
                width: '90vw',
                padding: '1rem',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    popup: 'swal2-popup-fullscreen',
                    closeButton: 'swal2-close-fullscreen'
                },
                // ç‚ºäº†è®“åœ–ç‰‡ä½”æ»¿è¢å¹•ï¼ŒåŠ å…¥é¡å¤–çš„ CSS
                didOpen: (modal) => {
                    modal.style.maxWidth = '90vw';
                    modal.style.maxHeight = '90vh';
                    modal.style.width = '90vw';
                    modal.style.height = '90vh';
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
                    modal.querySelector('img').style.maxWidth = '100%';
                    modal.querySelector('img').style.maxHeight = '100%';
                },
                backdrop: true
            });
        }


        // --- Firebase Load and Save Functions (REPLACED) ---
        function loadData() {
            // åœæ­¢ä½¿ç”¨ LocalStorage è®€å–ï¼Œæ”¹ç‚ºå³æ™‚ç›£è½ Firestore
            TRIP_DOC_REF.onSnapshot(doc => {
                if (doc.exists) {
                    const cloudData = doc.data();
                    console.log("æ•¸æ“šå·²å¾é›²ç«¯åŒæ­¥ï¼");

                    // 1. åˆä½µé›²ç«¯æ•¸æ“šåˆ° appData
                    appData = { 
                        ...appData, 
                        ...cloudData 
                    };
                    
                    // ç¢ºä¿å¿…è¦æ¬„ä½å­˜åœ¨
                    if (!appData.note) appData.note = {text: '', img: null};
                    if (!appData.widgetsOrder.includes('note')) appData.widgetsOrder.push('note');
                    if (!appData.widgetsOrder.includes('countdown')) appData.widgetsOrder.unshift('countdown');
                    if(appData.budget === undefined) appData.budget = 150000;


                    // 2. é‡æ–°åˆå§‹åŒ–æ‰€æœ‰éœ€è¦æ•¸æ“šçš„å…ƒä»¶
                    initHeader();
                    // é‡æ–°æ¸²æŸ“ç•¶å‰è¦–åœ–
                    if (currentView === 'home') renderHome();
                    else if (currentView === 'plan') renderPlan();
                    else if (currentView === 'map') renderMap();
                    else if (currentView === 'info') renderInfo();
                    else if (currentView === 'wallet') renderWallet();
                    
                } else {
                    console.log("é›²ç«¯æ•¸æ“šåº«ä¸­æ²’æœ‰æ­¤è¡Œç¨‹ï¼Œå°‡ä½¿ç”¨é è¨­æ•¸æ“šä¸¦ä¸Šå‚³ã€‚");
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯«å…¥ä¸€å€‹åˆå§‹çµæ§‹
                    if (appData.itinerary.length === 0) { 
                        appData.itinerary = [
                            { id: 101, day: 1, time: '11:55', type: 'TRANSPORT', title: 'äºèˆª æŠµé”ç¦å²¡', travelTime: '', duration: '', budget: '', mapUrl: '', tags: ['èˆªç­'], tasks: [], completed: false, lat: 33.5859, lng: 130.4501 },
                            { id: 102, day: 1, time: '15:00', type: 'SPOT', title: 'å¤©ç¥é€›è¡—', travelTime: '', duration: '', budget: '', mapUrl: '', tags: ['è³¼ç‰©'], tasks: [], completed: false, lat: 33.5902, lng: 130.4017 },
                            { id: 103, day: 1, time: '20:00', type: 'HOTEL', title: 'åšå¤šç«™å‰Richmond', travelTime: '', duration: '', budget: '', mapUrl: '', tags: ['ä½å®¿'], tasks: [], completed: false, lat: 33.589, lng: 130.420 },
                            { id: 201, day: 2, time: '08:00', type: 'FOOD', title: 'dacomecca', travelTime: '', duration: '', budget: '', mapUrl: '', tags: ['æ—©é¤'], tasks: [], completed: false, lat: 33.589, lng: 130.422 },
                            { id: 202, day: 2, time: '09:30', type: 'SPOT', title: 'æ«›ç”°ç¥ç¤¾', travelTime: '', duration: '', budget: '', mapUrl: '', tags: ['æ™¯é»'], tasks: [], completed: false, lat: 33.593, lng: 130.410 },
                        ];
                        appData.note = {text: 'éš¨æ‰‹è¨˜...\n1. é£¯åº— Wifi: happy2026', img: null};
                        appData.shopping = [{id: 201, text: 'ç¦å²¡é™å®šæ˜å¤ªå­', img: null, checked: false}];
                        appData.isLiveRate = true; 
                        saveData(true); // é¦–æ¬¡ä¸Šå‚³é è¨­æ•¸æ“š
                    }
                }
            }, err => {
                console.error("å³æ™‚åŒæ­¥ç›£è½å¤±æ•—:", err);
                Swal.fire('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°å…±ç”¨è¡Œç¨‹è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'error');
            });
        }
        
        function saveData(silent = false) { 
            // åœæ­¢ä½¿ç”¨ LocalStorage å¯«å…¥ï¼Œæ”¹ç‚ºå¯«å…¥ Firestore
            return TRIP_DOC_REF.set(appData, { merge: true })
                .then(() => {
                    if (!silent) {
                        console.log("æ•¸æ“šå·²æˆåŠŸå¯«å…¥é›²ç«¯ã€‚");
                    }
                })
                .catch((error) => {
                    console.error("å¯«å…¥é›²ç«¯å¤±æ•—:", error);
                    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å„²å­˜æ‚¨çš„è®Šæ›´ã€‚', 'error');
                    throw error; // æ‹‹å‡ºéŒ¯èª¤ä»¥ä¾¿èª¿ç”¨è€…çŸ¥é“å¤±æ•—
                });
        }
        // ----------------------------------------------------

        function initDecorations() {
            const layer = document.getElementById('sticker-layer') || document.createElement('div');
            layer.id = 'sticker-layer';
            layer.className = 'fixed inset-0 pointer-events-none overflow-hidden z-0';
            document.body.appendChild(layer);
            const icons = [ {c: 'fa-solid fa-star', col: '#E3C16F'}, {c: 'fa-solid fa-heart', col: '#D48C7D'}, {c: 'fa-solid fa-bread-slice', col: '#A98467'}, {c: 'fa-solid fa-ribbon', col: '#D48C7D'}, {c: 'fa-solid fa-lemon', col: '#E3C16F'} ];
            for(let i=0; i<8; i++) {
                const icon = icons[Math.floor(Math.random() * icons.length)];
                const el = document.createElement('div');
                el.className = 'cute-sticker';
                el.innerHTML = `<i class="${icon.c}" style="color:${icon.col}"></i>`;
                el.style.top = Math.random() * 90 + '%';
                el.style.left = Math.random() * 90 + '%';
                el.style.transform = `rotate(${Math.random()*60 - 30}deg) scale(${0.8 + Math.random()*0.4})`;
                layer.appendChild(el);
            }
        }

        function router(view) {
            vibrate();
            const container = document.getElementById('app-container');
            if(container) { scrollPositions[currentView] = container.scrollTop; container.innerHTML = ''; }
            currentView = view;
            const fab = document.getElementById('fab-add');
            const dateSection = document.getElementById('date-section');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.target === view));
            
            // FIX: ç¢ºä¿åœ¨åˆ‡æ¢åˆ° plan æˆ– map æ™‚ï¼Œæ—¥æœŸå€å¡Šè¢«é¡¯ç¤ºä¸¦é‡æ–°æ¸²æŸ“æ¨™é ­
            if (view === 'plan' || view === 'map') {
                dateSection.classList.remove('hidden-dates');
                initHeader(); // é‡æ–°æ¸²æŸ“å¤©æ•¸é¸æ“‡å™¨
            } else {
                dateSection.classList.add('hidden-dates');
            }

            fab.classList.remove('hidden'); 
            if (view === 'home') renderHome();
            else if (view === 'plan') renderPlan();
            else if (view === 'map') renderMap();
            else if (view === 'info') renderInfo();
            else if (view === 'wallet') renderWallet();
            if(container) requestAnimationFrame(() => container.scrollTop = scrollPositions[view] || 0);
        }

        // --- Day Grid ---
        function toggleDayGrid() {
            const overlay = document.getElementById('day-grid-overlay');
            const content = document.getElementById('day-grid-content');
            if(overlay.classList.contains('hidden')) {
                let gridHtml = '';
                for(let i=1; i<=9; i++) {
                    const d = new Date(START_DATE); d.setDate(d.getDate() + (i-1));
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    const firstItem = appData.itinerary.find(item => item.day === i);
                    const label = firstItem ? firstItem.title : 'å°šç„¡è¡Œç¨‹';
                    const activeClass = appData.currentDay === i ? 'ring-2 ring-m-spot bg-white' : 'bg-white/80';
                    gridHtml += `<div onclick="switchDay(${i}); toggleDayGrid()" class="p-4 rounded-2xl shadow-sm cursor-pointer hover:bg-white transition-all ${activeClass}"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400 font-hand">DAY ${i}</span><span class="text-xs font-mono text-theme-dark font-hand">${dateStr}</span></div><div class="text-sm font-bold text-theme-dark truncate">${label}</div></div>`;
                }
                content.innerHTML = gridHtml;
                overlay.classList.remove('hidden');
            } else { overlay.classList.add('hidden'); }
        }
        function toggleMapFilter(type) { vibrate(); if (mapFilters === type) mapFilters = null; else mapFilters = type; renderMap(); }

        // --- 1. PLAN ---
        function toggleCard(id) { const el = document.querySelector(`.ticket-container[data-id="${id}"]`); if(el) el.classList.toggle('expanded'); }
        function formatHighlights(text) { if(!text) return ''; let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); html = html.replace(/(å¿…åƒ|å¿…é»)[:ï¼š\s]*([^<]+)/g, '<span class="hl-food">$1 $2</span>'); html = html.replace(/(å¿…è²·|ä¼´æ‰‹ç¦®)[:ï¼š\s]*([^<]+)/g, '<span class="hl-buy">$1 $2</span>'); html = html.replace(/(é ç´„|ä»£è™Ÿ|ç·¨è™Ÿ)[:ï¼š\s]*([A-Za-z0-9\-]+)/g, '<span class="hl-code">$1 $2</span>'); return html; }

        function renderPlan() {
            const container = document.getElementById('app-container');
            const items = appData.itinerary.filter(i => i.day === appData.currentDay).sort((a, b) => a.time.localeCompare(b.time));
            
            if (items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-24 px-10 text-center"><div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-sticker mb-4 border border-white"><i class="fa-solid fa-route text-4xl text-m-spot opacity-80"></i></div><h3 class="font-serif text-xl text-theme-dark mb-2 font-bold">ç©ºç©ºå¦‚ä¹Ÿ</h3><p class="text-sm text-gray-400 mb-6 font-hand">é»æ“Šä¸‹æ–¹ + é–‹å§‹è¦åŠƒè¡Œç¨‹</p></div>`;
                const addCardHtml = `<div onclick="openEdit('plan')" class="add-ticket group mx-4"><div class="flex flex-col items-center gap-1 group-active:scale-95 transition-transform"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-m-other shadow-sm border border-m-other/30"><i class="fa-solid fa-plus"></i></div><span class="text-xs font-bold tracking-widest text-m-other font-hand">ADD PLAN</span></div></div>`;
                container.innerHTML += addCardHtml;
                return;
            }
            
            let html = items.map((item, index) => {
                const conf = CATEGORIES[item.type] || CATEGORIES['OTHER'];
                const tagsHtml = (item.tags || []).map(t => `<span class="px-2 py-0.5 bg-gray-100 text-gray-500 text-[10px] rounded-md font-bold mr-1 border border-gray-200">${t}</span>`).join('');
                const tasksHtml = (item.tasks || []).map((t, idx) => {
                    const hlText = formatHighlights(t.text);
                    return `<div class="flex items-center gap-2 py-1 cursor-pointer" onclick="toggleTask(event, ${item.id}, ${idx})"><i class="fa-regular ${t.done ? 'fa-square-check text-m-spot' : 'fa-square text-gray-300'}"></i><span class="text-xs ${t.done ? 'line-through text-gray-300' : 'text-gray-600'} font-hand">${hlText}</span></div>`;
                }).join('');
                const infoBar = `<div class="flex items-center gap-3 text-[10px] text-gray-400 mt-2 font-hand font-bold">${item.duration ? `<span><i class="fa-regular fa-clock"></i> ${item.duration}</span>` : ''}${item.budget ? `<span><i class="fa-solid fa-yen-sign"></i> ${item.budget}</span>` : ''}</div>`;
                const stampHtml = `<div class="stamp-mark ${item.completed ? 'stamp-visible' : ''}" id="stamp-${item.id}"><span>æ¿Ÿ</span><span class="text-[8px] tracking-widest border-t border-red-800 mt-1 pt-0.5">COMPLETED</span></div>`;
                const isCompletedClass = item.completed ? 'ticket-completed' : '';
                const safeTitle = item.title.replace(/'/g, "\\'");
                const mapLink = item.mapUrl && item.mapUrl.trim() !== '' ? item.mapUrl : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;

                return `
                    <div class="ticket-container relative group ${isCompletedClass}" data-id="${item.id}" onclick="toggleCard(${item.id})">
                        <div class="washi-tape-top" style="background-color:${conf.tape}"></div>
                        ${item.travelTime ? `<div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur px-3 py-0.5 rounded-full text-[10px] text-gray-500 border border-white shadow-sm flex items-center gap-1 z-0 pointer-events-none font-hand font-bold"><i class="fa-solid fa-person-walking"></i>${item.travelTime}</div>` : ''}
                        <div class="ticket-wrap relative">
                            ${stampHtml}
                            <div class="ticket-stub ${conf.color}">
                                <span class="font-hand text-xl font-bold tracking-tighter opacity-90">${item.time}</span>
                                <div class="my-1 text-2xl opacity-80"><i class="fa-solid ${conf.icon}"></i></div>
                                <span class="text-[9px] font-bold uppercase tracking-widest border border-white/30 px-1 rounded">${conf.name}</span>
                                <span class="absolute bottom-2 text-[8px] font-mono opacity-50 rotate-90 right-1 origin-bottom-right">NO.${index + 1}</span>
                            </div>
                            <div class="ticket-body">
                                <div class="flex justify-between items-start">
                                    <div class="min-w-0 pr-2">
                                        <h3 class="font-serif text-xl font-bold text-theme-dark leading-tight line-clamp-2">${item.title}</h3>
                                        <div class="flex flex-wrap gap-1 mt-1">${tagsHtml}</div>
                                    </div>
                                    <div class="flex flex-col gap-3">
                                        <button onclick="openEdit('plan', ${item.id}); event.stopPropagation();" class="text-gray-300 hover:text-theme-dark bg-gray-50 p-2 rounded-full active:bg-gray-100 transition-colors"><i class="fa-solid fa-pencil"></i></button>
                                        <i class="fa-solid fa-grip-lines text-gray-200 drag-handle cursor-grab p-1"></i>
                                    </div>
                                </div>
                                ${(item.duration || item.budget) ? infoBar : ''}
                                <div class="ticket-details">
                                    ${tasksHtml ? `<div class="bg-gray-50 rounded p-2 mt-2 space-y-1 border border-gray-100">${tasksHtml}</div>` : ''}
                                    <div class="grid grid-cols-2 gap-2 mt-3">
                                        <button onclick="toggleComplete(event, ${item.id})" class="py-2 bg-white border border-red-200 text-red-500 rounded-lg text-xs font-bold shadow-sm active:scale-95 flex items-center justify-center gap-1 z-20">
                                            <i class="fa-regular ${item.completed ? 'fa-circle-xmark' : 'fa-circle-check'}"></i> ${item.completed ? 'å–æ¶ˆå®Œæˆ' : 'â­• å®Œæˆ'}
                                        </button>
                                        <button onclick="openGuide(event, '${safeTitle}', '${item.lat}', '${item.lng}')" class="py-2 btn-guide rounded-lg text-xs flex items-center justify-center gap-1 z-20"><i class="fa-solid fa-wand-magic-sparkles"></i> AI å°éŠ</button>
                                    </div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <a href="${mapLink}" target="_blank" class="flex-1 text-center py-1.5 bg-theme-dark text-white rounded text-xs font-bold shadow-sm" onclick="event.stopPropagation()">å°èˆª</a>
                                        <a href="https://www.google.com/search?q=${encodeURIComponent(item.title + ' æ”»ç•¥')}" target="_blank" class="flex-1 text-center py-1.5 bg-white border border-gray-200 text-theme-dark rounded text-xs font-bold shadow-sm" onclick="event.stopPropagation()">æ”»ç•¥</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const addCardHtml = `<div onclick="openEdit('plan')" class="add-ticket group mx-4"><div class="flex flex-col items-center gap-1 group-active:scale-95 transition-transform"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-m-other shadow-sm border border-m-other/30"><i class="fa-solid fa-plus"></i></div><span class="text-xs font-bold tracking-widest text-m-other font-hand">ADD PLAN</span></div></div>`;
            container.innerHTML = `<div id="plan-list" class="px-4 py-6">${html}</div>${addCardHtml}`;
            if(document.getElementById('plan-list')) new Sortable(document.getElementById('plan-list'), { animation: 200, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function (evt) { const newOrderIds = Array.from(document.querySelectorAll('.ticket-container')).map(el => parseInt(el.getAttribute('data-id'))); const currentItems = appData.itinerary.filter(i => i.day === appData.currentDay); const otherItems = appData.itinerary.filter(i => i.day !== appData.currentDay); const reorderedItems = newOrderIds.map(id => currentItems.find(i => i.id === id)).filter(Boolean); appData.itinerary = [...otherItems, ...reorderedItems]; saveData(); /* renderPlan() removed */ } } );
        }

        // --- GUIDE MODAL (MAGAZINE STYLE) ---
        function openGuide(e, title, lat, lng) {
            e.stopPropagation();
            const modal = document.getElementById('guide-modal');
            const img = document.getElementById('guide-img');
            const titleEl = document.getElementById('guide-title');
            const descEl = document.getElementById('guide-desc');
            const mapContainer = document.getElementById('guide-map');
            const link = document.getElementById('guide-link');

            titleEl.innerText = title;
            img.src = `https://source.unsplash.com/random/800x600/?${title},Japan,Kyushu`; 
            
            descEl.innerHTML = `
                ä½æ–¼ä¹å·çš„ ${title} æ˜¯ä¸€å€‹å……æ»¿é­…åŠ›çš„åœ°æ–¹ã€‚é€™è£¡ä¸åƒ…æœ‰è±å¯Œçš„æ­·å²æ–‡åŒ–ï¼Œé‚„æœ‰ä»¤äººå‚æ¶çš„ç¾é£Ÿã€‚
                ç„¡è«–æ˜¯ç•¶åœ°çš„ç‰¹è‰²å°åƒï¼Œé‚„æ˜¯å£¯éº—çš„è‡ªç„¶æ™¯è§€ï¼Œéƒ½èƒ½è®“æ—…äººæµé€£å¿˜è¿”ã€‚
                <br><br>
                ğŸ’¡ <b>å°çŸ¥è­˜ï¼š</b> é€™è£¡åœ¨ç•¶åœ°äººå¿ƒä¸­æ“æœ‰æ¥µé«˜çš„äººæ°£ï¼Œå»ºè­°é¿é–‹é€±æœ«äººæ½®å‰å¾€å–”ï¼
            `;

            if (lat && lng && lat !== 'undefined') {
                 mapContainer.innerHTML = `<iframe id="guide-map-frame" width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(lng)-0.01},${parseFloat(lat)-0.01},${parseFloat(lng)+0.01},${parseFloat(lat)+0.01}&layer=mapnik&marker=${lat},${lng}"></iframe>`;
            } else {
                 mapContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-100 text-xs">æš«ç„¡ç²¾ç¢ºåº§æ¨™</div>`;
            }

            link.href = `https://www.google.com/search?q=${encodeURIComponent(title + ' ä»‹ç´¹ æ­·å²')}`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeGuide() {
             const modal = document.getElementById('guide-modal');
             modal.classList.add('hidden');
             modal.classList.remove('flex');
        }

        // --- 1. HOME ---
        function renderHome() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div id="home-widgets" class="p-4 space-y-6"></div>`;
            const wContainer = document.getElementById('home-widgets');
            appData.widgetsOrder.forEach(type => {
                if(type === 'countdown') wContainer.innerHTML += getCountdownWidgetHTML();
                if(type === 'weather') wContainer.innerHTML += getWeatherWidgetHTML();
                if(type === 'calc') wContainer.innerHTML += getCalcWidgetHTML();
                if(type === 'shop') wContainer.innerHTML += getShopWidgetHTML();
                if(type === 'note') wContainer.innerHTML += getNoteWidgetHTML();
            });
            new Sortable(wContainer, { animation: 200, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: function (evt) { const newOrder = Array.from(wContainer.children).map(el => el.getAttribute('data-id')); appData.widgetsOrder = newOrder; saveData(); } });
        }
        function getCountdownWidgetHTML() {
            const today = new Date();today.setHours(0,0,0,0);
            const start = new Date(START_DATE);start.setHours(0,0,0,0);
            const diff = start - today;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            const displayDays = days > 0 ? days : 0;
            const label = days > 0 ? 'DAYS LEFT' : (days === 0 ? 'TODAY IS THE DAY!' : 'TRIP STARTED');
            return `<div class="hard-card p-6 relative overflow-visible flex flex-col items-center text-center" data-id="countdown"><div class="torn-edge"></div><div class="washi-tape" style="top: -12px; transform: translateX(-50%) rotate(2deg); width: 80px; background-color: rgba(210, 180, 140, 0.6);"></div><div class="mt-5 relative z-10"><span class="text-xs font-mono text-gray-400 tracking-[0.2em] uppercase">ä¹å·å‡ºç™ºã¾ã§</span><div class="font-hand text-[7rem] leading-none text-red-800 my-2" style="text-shadow: 3px 3px 0px rgba(220, 150, 150, 0.3); font-feature-settings: 'tnum' on, 'lnum' on;">${displayDays}</div><span class="font-serif font-bold text-xl text-theme-dark">${label}</span></div><i class="fa-solid fa-grip-dots drag-handle text-gray-300 absolute bottom-4 right-4"></i><i class="fa-solid fa-calendar-check bg-icon text-6xl -left-2 bottom-2 rotate-12 text-red-900 opacity-5"></i></div>`;
        }
        function getWeatherWidgetHTML() { const data = WEATHER_DATA[appData.weatherCity || 'Fukuoka']; const forecastHtml = data.forecast.map(day => `<div class="flex flex-col items-center relative z-10"><span class="text-[10px] text-gray-400 font-mono mb-1">${day.d}</span><i class="fa-solid ${day.i} text-theme-dark text-lg mb-1"></i><span class="text-xs font-bold text-gray-500 font-hand">${day.h}Â°</span></div>`).join(''); return `<div class="hard-card p-5" data-id="weather"><i class="fa-solid fa-sun bg-icon -right-4 -top-4 text-7xl rotate-12 text-yellow-500"></i><div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3 relative z-10"><div><div class="flex items-center gap-2 cursor-pointer bg-white/80 px-2 py-1 rounded-lg hover:bg-white transition-colors border border-gray-100" onclick="toggleCity(); event.stopPropagation();"><h3 class="font-serif text-xl font-bold text-theme-dark">${appData.weatherCity}</h3><i class="fa-solid fa-rotate text-xs text-m-transport"></i></div><p class="text-xs text-gray-400 mt-1 pl-1 font-hand">${data.current.cond}</p></div><div class="flex flex-col items-end"><i class="fa-solid fa-grip-dots drag-handle mb-1 text-gray-300"></i><span class="text-4xl font-hand text-theme-dark">${data.current.temp}Â°</span></div></div><div class="flex justify-between px-1">${forecastHtml}</div></div>`; }
        function getCalcWidgetHTML() { 
            const liveIndicator = appData.isLiveRate ? '<span class="ml-2 w-2 h-2 rounded-full bg-green-400 inline-block animate-pulse shadow-[0_0_5px_#4ade80]" title="å³æ™‚åŒ¯ç‡"></span>' : '';
            return `<div class="hard-card p-5" data-id="calc"><i class="fa-solid fa-calculator bg-icon -right-4 bottom-2 text-6xl rotate-12 text-m-spot"></i><div class="flex justify-between items-start relative z-10"><div class="flex items-center"><h3 class="font-serif font-bold text-theme-dark mb-3">Rate Calc</h3>${liveIndicator} <span class="mb-3 text-[10px] bg-white/80 px-2 py-1 rounded ml-2 text-gray-500 cursor-pointer border border-gray-100 hover:bg-gray-50" onclick="changeRate()">x ${appData.rate.toFixed(3)}</span></div><i class="fa-solid fa-grip-dots drag-handle text-gray-300"></i></div><input type="text" id="calc-in" class="w-full bg-white/80 rounded-xl p-3 text-xl font-hand mb-3 outline-none input-polish relative z-10" placeholder="e.g. 500+200*3" onkeydown="if(event.key==='Enter') runCalc()"><div class="flex justify-between items-baseline px-1 relative z-10"><span class="text-xs text-gray-400">JPY to TWD</span><span id="calc-out" class="font-hand font-bold text-2xl text-m-food">0</span></div></div>`; 
        }
        function getNoteWidgetHTML() { const hasImg=appData.note.img; return `<div class="hard-card p-5 note-card rotate-1" data-id="note" onclick="openEdit('note')"><div class="washi-tape" style="background-color:rgba(230, 200, 150, 0.5)"></div><div class="flex justify-between items-start mb-2 relative z-10"><h3 class="font-serif font-bold text-theme-dark"><i class="fa-solid fa-pen-nib mr-2 opacity-50"></i>Memo</h3><i class="fa-solid fa-grip-dots drag-handle text-yellow-600 opacity-50"></i></div><div class="relative z-10 min-h-[80px]">${hasImg?`<div class="mb-2 rounded-lg overflow-hidden border-2 border-white shadow-sm rotate-2 w-24 h-24 float-right ml-2"><img src="${appData.note.img}" class="w-full h-full object-cover"></div>`:''}<p class="text-sm font-hand text-theme-dark whitespace-pre-wrap leading-relaxed">${appData.note.text || 'é»æ“Šæ–°å¢ç­†è¨˜...'}</p></div></div>`; }
        function getShopWidgetHTML() { 
            const items = appData.shopping.map((i, idx) => {
                const imgEl = i.img ? `<img src="${i.img}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-bag-shopping text-gray-300 text-xl"></i>';
                const clickableImg = i.img ? `onclick="showImageFullscreen('${i.img}'); event.stopPropagation();"` : '';
                
                return `<div class="shrink-0 hard-card w-32 p-3 flex flex-col items-center justify-center cursor-pointer relative group/item ${getRotate(idx)}" onclick="openEdit('shop', ${i.id}); event.stopPropagation();">
                        <div class="w-full h-20 bg-gray-100 mb-2 overflow-hidden flex items-center justify-center rounded-lg border border-gray-100" ${clickableImg}>${imgEl}</div>
                        <span class="font-hand text-xs truncate w-full text-center mt-1 ${i.checked ? 'line-through text-gray-300' : 'text-theme-dark'}">${i.text}</span>
                        <div onclick="toggleShop(event, ${i.id})" class="absolute top-1 left-1 w-5 h-5 rounded-full bg-white flex items-center justify-center shadow-sm z-10">${i.checked ? '<i class="fa-solid fa-check text-xs text-m-spot"></i>' : ''}</div>
                    </div>`;
            }).join(''); 
            
            return `<div class="hard-card p-5 overflow-visible" data-id="shop"><i class="fa-solid fa-receipt bg-icon right-10 -top-2 text-6xl -rotate-6 text-gray-400"></i><div class="flex justify-between items-center mb-3 relative z-10"><h3 class="font-serif font-bold text-theme-dark">Shopping List</h3><i class="fa-solid fa-grip-dots drag-handle text-gray-300"></i></div><div class="flex overflow-x-auto gap-4 pb-2 -mx-2 px-2 no-scrollbar relative z-10 min-h-[160px]">${items}<button onclick="openEdit('shop')" class="shrink-0 w-28 h-32 border-2 border-dashed border-gray-300 rounded-2xl flex items-center justify-center text-gray-300 hover:text-m-spot hover:border-m-spot transition-colors bg-white/50"><i class="fa-solid fa-plus"></i></button></div></div>`; 
        }

        // --- Other Modules ---
        function renderMap() { 
            const container = document.getElementById('app-container');
            const chipsHtml = FILTER_OPTIONS.map(opt => `<button onclick="toggleMapFilter('${opt.key}')" class="map-filter-chip whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold border transition-all shadow-sm ${mapFilters === opt.key ? `${opt.color} text-white border-transparent active` : 'bg-white text-theme-dark border-gray-200'}">${opt.label}</button>`).join('');
            container.innerHTML = `<div class="absolute top-4 left-4 right-4 z-[500] flex gap-2 overflow-x-auto no-scrollbar pb-2">${chipsHtml}</div><div id="map" class="w-full h-full z-10"></div>`;
            setTimeout(() => { 
                if(mapInstance) { mapInstance.remove(); mapInstance = null; } 
                mapInstance = L.map('map', {zoomControl: false}).setView([33.5902, 130.4017], 13); 
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(mapInstance); 
                const bounds=[]; const latlngs=[];
                let dayItems = appData.itinerary.filter(i => i.day === appData.currentDay).sort((a, b) => a.time.localeCompare(b.time));
                if(mapFilters) dayItems = dayItems.filter(i => i.type === mapFilters);
                dayItems.forEach((item, index) => { 
                    const lat = item.lat || (33.5902 + (Math.random()-0.5)*0.05); const lng = item.lng || (130.4017 + (Math.random()-0.5)*0.05); 
                    const point = [lat, lng]; latlngs.push(point); bounds.push(point);
                    const icon = L.divIcon({className: 'custom-icon', html: `<div class="w-8 h-8 rounded-full bg-theme-dark border-2 border-white shadow-lg flex items-center justify-center text-white font-bold font-mono text-sm">${index+1}</div>`, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]}); 
                    L.marker(point, {icon: icon}).addTo(mapInstance).bindPopup(`<b>${item.title}</b><br>${item.time}`); 
                }); 
                if(!mapFilters && latlngs.length > 1) L.polyline(latlngs, {color: '#8EA4B5', weight: 4, opacity: 0.8, dashArray: '10, 10'}).addTo(mapInstance);
                if(bounds.length) mapInstance.fitBounds(bounds, {padding:[50,50], maxZoom: 15}); 
                
                // FIX: å¼·åˆ¶åœ°åœ–é‡æ–°è¨ˆç®—å¤§å°ï¼Œç¢ºä¿å®Œæ•´é¡¯ç¤º
                mapInstance.invalidateSize(); 

            }, 100); 
        }

        function renderWallet() { 
            const container = document.getElementById('app-container');
            let grandTotal = 0, totals = {}; appData.expenses.forEach(e => { totals[e.type] = (totals[e.type]||0) + Number(e.amount); grandTotal += Number(e.amount); });
            const totalBudget = appData.budget || 150000;
            const percent = Math.min((grandTotal / totalBudget) * 100, 100);
            let barColor = 'bg-green-400';
            if(percent > 50) barColor = 'bg-yellow-400';
            if(percent > 80) barColor = 'bg-red-400';
            const budgetHtml = `<div class="hard-card p-6 mb-6"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400 uppercase tracking-widest font-hand">BUDGET</span><button onclick="openEdit('budget')" class="text-xs bg-gray-100 px-2 py-1 rounded text-theme-dark"><i class="fa-solid fa-gear mr-1"></i>è¨­å®š</button></div><div class="flex justify-between items-end mb-2"><span class="text-2xl font-hand font-bold text-theme-dark">ï¿¥${grandTotal.toLocaleString()}</span><span class="text-xs text-gray-400 font-hand">/ ï¿¥${totalBudget.toLocaleString()}</span></div><div class="budget-bar-container"><div class="budget-fill ${barColor}" style="width: ${percent}%"></div></div></div>`;
            let grad = [], deg = 0; const wColors = {'FOOD':'#C98878', 'TRANSPORT':'#8EA4B5', 'SHOPPING':'#9CA890', 'OTHER':'#9CA880', 'HOTEL':'#6D6875'};
            Object.keys(totals).forEach(t => { const d = (totals[t]/grandTotal)*360; grad.push(`${wColors[t]||'#ccc'} ${deg}deg ${deg+d}deg`); deg+=d; });
            const bg = grad.length ? `conic-gradient(${grad.join(', ')})` : '#eee';
            const list = appData.expenses.slice().reverse().map((e) => `<div class="flex justify-between items-center hard-card p-4 mb-3"><div class="flex items-center gap-4"><div class="w-2.5 h-10 rounded-full" style="background-color:${wColors[e.type]||'#ccc'}"></div><div><h4 class="font-bold text-theme-dark text-lg">${e.title}</h4><p class="text-xs text-gray-400 font-mono mt-0.5">${e.type}</p></div></div><span class="font-mono font-bold text-lg text-theme-dark font-hand">ï¿¥${Number(e.amount).toLocaleString()}</span></div>`).join('');
            container.innerHTML = `<div class="p-5">${budgetHtml}<div class="hard-card p-6 mb-8 flex items-center justify-between"><div><p class="text-xs uppercase tracking-widest text-gray-400 mb-1">Breakdown</p><div class="flex gap-2 flex-wrap text-[10px] text-gray-500">${Object.keys(totals).map(k=>`<span class="px-2 py-1 bg-gray-100 rounded">${k}</span>`).join('')}</div></div><div class="pie-chart shadow-inner" style="background: ${bg}"><div class="pie-hole shadow-sm border border-gray-100"></div></div></div><div class="pb-20 space-y-2">${list}</div></div>`;
        }

        function renderInfo() {
            const container = document.getElementById('app-container');
            const vouchers = appData.vouchers || [];
            let listHtml = vouchers.map((v, idx) => {
                const conf = VOUCHER_CATS[v.type] || VOUCHER_CATS['OTHER'];
                const rotate = ['rotate-v-1', 'rotate-v-2', 'rotate-v-3'][idx % 3];
                
                const imgEl = v.img ? `<img src="${v.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-2xl"></i></div>`;
                const clickableImg = v.img ? `onclick="showImageFullscreen('${v.img}'); event.stopPropagation();"` : '';
                
                return `<div class="hard-card p-3 cursor-pointer ${rotate} group relative transition-transform hover:z-10" onclick="openEdit('info', ${v.id})">
                        <div class="washi-tape" style="background-color:${conf.tape}; width: 50px; height: 16px; top: -5px;"></div>
                        <div class="aspect-[4/3] bg-gray-100 rounded-lg overflow-hidden mb-2 relative border border-gray-100" ${clickableImg}>${imgEl}
                            <div class="absolute bottom-1 right-1 w-6 h-6 rounded-full bg-white flex items-center justify-center text-xs shadow-sm ${conf.color} text-white"><i class="fa-solid ${conf.icon}"></i></div>
                        </div>
                        <h4 class="font-bold text-sm text-theme-dark leading-tight mb-1 truncate">${v.title}</h4>
                        ${v.text ? `<p class="text-[10px] text-gray-400 line-clamp-2 leading-relaxed font-hand">${v.text}</p>` : ''}
                    </div>`;
            }).join('');
            listHtml += `<div class="add-voucher-card group" onclick="openEdit('info')"><div class="w-12 h-12 rounded-full bg-m-other/20 flex items-center justify-center mb-2 group-active:scale-90 transition-transform"><i class="fa-solid fa-plus text-xl text-m-other"></i></div><span class="text-xs font-bold text-gray-400 tracking-widest font-hand">ADD NEW</span></div>`;
            // Calculate size dynamically
            const tempStr = JSON.stringify(appData); 
            const size = (tempStr.length * 2) / 1024 / 1024; // Approximation
            const MAX_FIREBASE_FREE_STORAGE = 4.8; // Firestore limit in free tier for rough estimation
            const percent = Math.min((size / MAX_FIREBASE_FREE_STORAGE) * 100, 100);

            const backupSection = `<div class="hard-card p-6 mb-8"><h3 class="font-serif font-bold text-lg text-theme-dark mb-4 flex items-center"><i class="fa-solid fa-cloud-arrow-up mr-2 text-m-transport"></i>Data Backup</h3><div class="mb-5"><div class="flex justify-between text-xs text-gray-400 mb-2 font-hand"><span>Cloud Storage (Est.)</span><span>${size.toFixed(2)} MB used</span></div><div class="h-2 bg-gray-100 rounded-full overflow-hidden border border-gray-200"><div class="h-full bg-theme-dark transition-all duration-1000 ease-out" style="width:${percent}%"></div></div></div><div class="flex gap-3"><button onclick="exportData()" class="flex-1 bg-theme-dark text-white py-3.5 rounded-xl font-bold text-sm shadow-md active:translate-y-0.5 active:shadow-none transition-all font-hand">å‚™ä»½ä¸‹è¼‰</button><button onclick="document.getElementById('restore-file').click()" class="flex-1 bg-white border-2 border-gray-200 text-theme-dark py-3.5 rounded-xl font-bold text-sm shadow-sm active:translate-y-0.5 active:shadow-none transition-all font-hand">è®€å–æª”æ¡ˆ</button></div></div>`;
            container.innerHTML = `<div class="p-5"><h2 class="font-display text-2xl text-theme-dark mb-4 pl-1">Vouchers</h2><div class="grid grid-cols-2 gap-4 mb-8">${listHtml}</div>${backupSection}</div><div class="h-20"></div>`; 
        }

        // --- Handlers & Edits ---
        function toggleComplete(e, id) { e.stopPropagation(); vibrate(); const item = appData.itinerary.find(i => i.id === id); if(item) { item.completed = !item.completed; if (item.completed) { saveData(); const stamp = document.getElementById(`stamp-${id}`); if(stamp) { stamp.classList.remove('stamp-visible'); void stamp.offsetWidth; stamp.classList.add('stamp-animate'); } } else { saveData(); } } }
        function toggleTask(e, itemId, taskIdx) { e.stopPropagation(); const item = appData.itinerary.find(i => i.id === itemId); if(item && item.tasks[taskIdx]) { item.tasks[taskIdx].done = !item.tasks[taskIdx].done; const allDone = item.tasks.every(t => t.done); if (allDone && !item.completed) { item.completed = true; saveData(); } else { saveData(); } } }
        function openGuide(e, title) { e.stopPropagation(); Swal.fire({ title: `<span class="font-serif text-theme-dark"><i class="fa-solid fa-robot mr-2 text-m-spot"></i>${title}</span>`, html: `<div class="text-left"><p class="text-sm text-gray-500 mb-4">æ­£åœ¨ç‚ºæ‚¨å°‹æ‰¾é—œæ–¼ ${title} çš„æƒ…å ±...</p><div class="grid grid-cols-2 gap-3"><a href="https://www.google.com/search?q=${encodeURIComponent(title + ' å¿…åƒ ç¾é£Ÿ')}" target="_blank" class="p-3 bg-red-50 border border-red-100 rounded-xl flex flex-col items-center gap-1 hover:bg-red-100 transition-colors"><i class="fa-solid fa-utensils text-red-400 text-xl"></i><span class="text-xs font-bold text-red-600">æ‰¾å¿…åƒ</span></a><a href="https://www.google.com/search?q=${encodeURIComponent(title + ' å¿…è²· ä¼´æ‰‹ç¦®')}" target="_blank" class="p-3 bg-green-50 border border-green-100 rounded-xl flex flex-col items-center gap-1 hover:bg-green-100 transition-colors"><i class="fa-solid fa-bag-shopping text-green-400 text-xl"></i><span class="text-xs font-bold text-green-600">æ‰¾å¿…è²·</span></a><a href="https://www.google.com/search?q=${encodeURIComponent(title + ' æ­·å² æ•…äº‹')}" target="_blank" class="p-3 bg-blue-50 border border-blue-100 rounded-xl flex flex-col items-center gap-1 hover:bg-blue-100 transition-colors"><i class="fa-solid fa-book-open text-blue-400 text-xl"></i><span class="text-xs font-bold text-blue-600">çœ‹æ•…äº‹</span></a><a href="https://www.instagram.com/explore/tags/${encodeURIComponent(title)}/" target="_blank" class="p-3 bg-pink-50 border border-pink-100 rounded-xl flex flex-col items-center gap-1 hover:bg-pink-100 transition-colors"><i class="fa-brands fa-instagram text-pink-400 text-xl"></i><span class="text-xs font-bold text-pink-600">çœ‹IGåœ–</span></a></div></div>`, showConfirmButton: false, showCloseButton: true, customClass: { popup: 'rounded-3xl' } }); }
        function handleFabClick() { if(currentView==='plan') openEdit('plan'); else if(currentView==='wallet') openEdit('wallet'); else if(currentView==='info') openEdit('info'); else if(currentView==='home') openEdit('shop'); }
        function toggleShop(e, id) { e.stopPropagation(); const i = appData.shopping.find(x=>x.id===id); if(i){ i.checked=!i.checked; saveData(); } }
        function toggleCity() { appData.weatherCity = appData.weatherCity === 'Fukuoka' ? 'Kumamoto' : 'Fukuoka'; saveData(); }
        async function changeRate() { const {value} = await Swal.fire({title:'è¨­å®šåŒ¯ç‡', input:'number', inputValue:appData.rate, confirmButtonColor:'#54463D'}); if(value) { appData.rate = parseFloat(value); saveData(); } }
        function runCalc() { const val = document.getElementById('calc-in').value; try { document.getElementById('calc-out').innerText = `NT$${Math.round(eval(val.replace(/x/g, '*')) * appData.rate).toLocaleString()}`; } catch(e) {} }
        function exportData() { const blob=new Blob([JSON.stringify(appData)],{type:'application/json'}), url=URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download=`Day${new Date().toISOString().slice(0,10)}_Itinerary.json`; a.click(); URL.revokeObjectURL(url); Swal.fire('å‚™ä»½å®Œæˆ', '', 'success'); }
        function performRestore(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(d.itinerary){ appData=d; saveData(); Swal.fire('é‚„åŸæˆåŠŸ','','success').then(()=>location.reload()); } }catch(err){ Swal.fire('å¤±æ•—','æ ¼å¼éŒ¯èª¤','error'); } }; r.readAsText(f); input.value=''; }
        function compressImage(file) { return new Promise(resolve=>{ const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const cvs=document.createElement('canvas'), ctx=cvs.getContext('2d'), max=800; let w=img.width, h=img.height; if(w>max){ h*=max/w; w=max; } cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); resolve(cvs.toDataURL('image/jpeg',0.5)); } }; r.readAsDataURL(file); }); }
        async function previewFileCompressed(input, imgId) { if(input.files&&input.files[0]) { const c=await compressImage(input.files[0]), img=document.getElementById(imgId); img.src=c; img.classList.remove('hidden'); } }

        const sheet = document.getElementById('edit-sheet'), overlay = document.getElementById('sheet-overlay'), sheetContent = document.getElementById('sheet-content');
        function openEdit(type, id = null) {
            vibrate(); let html = '';
            if(type==='plan') {
                const item = id ? appData.itinerary.find(i=>i.id===id) : {time:'10:00', type:'SPOT', title:'', travelTime:'', mapUrl:'', duration:'', budget:'', tags:[], tasks:[]};
                const tagsStr = (item.tags || []).join(', '); const tasksStr = (item.tasks || []).map(t => t.text).join('\n');
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">Edit Plan</h3><input type="hidden" id="form-id" value="${id||''}"><div class="flex gap-3 mb-4"><input id="form-time" type="time" class="p-4 bg-white rounded-2xl border-2 border-gray-100 w-1/2 input-polish text-lg font-hand" value="${item.time}"><select id="form-type" class="p-4 bg-white rounded-2xl border-2 border-gray-100 w-1/2 input-polish appearance-none font-hand"><option value="SPOT" ${item.type==='SPOT'?'selected':''}>æ™¯é»</option><option value="FOOD" ${item.type==='FOOD'?'selected':''}>ç¾é£Ÿ</option><option value="CAFE" ${item.type==='CAFE'?'selected':''}>å’–å•¡å»³</option><option value="TRANSPORT" ${item.type==='TRANSPORT'?'selected':''}>äº¤é€š</option><option value="HOTEL" ${item.type==='HOTEL'?'selected':''}>ä½å®¿</option><option value="OTHER" ${item.type==='OTHER'?'selected':''}>å…¶ä»–</option></select></div><input id="form-title" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish text-lg font-bold font-hand" placeholder="åœ°é»åç¨±" value="${item.title}"><div class="grid grid-cols-2 gap-3 mb-4"><input id="form-duration" class="p-4 bg-white rounded-2xl border-2 border-gray-100 input-polish text-sm font-hand" placeholder="åœç•™æ™‚é–“" value="${item.duration||''}"><input id="form-budget" type="number" class="p-4 bg-white rounded-2xl border-2 border-gray-100 input-polish text-sm font-hand" placeholder="é ç®—" value="${item.budget||''}"></div><input id="form-tags" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish text-sm font-hand" placeholder="æ¨™ç±¤ (ç”¨é€—è™Ÿåˆ†éš”)" value="${tagsStr}"><textarea id="form-tasks" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish text-sm h-24 resize-none font-hand" placeholder="å¾…è¾¦äº‹é … (ä¸€è¡Œä¸€å€‹)">${tasksStr}</textarea><input id="form-travel" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish font-hand" placeholder="ä¸‹å€‹é»äº¤é€šæ™‚é–“" value="${item.travelTime||''}"><input id="form-map" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-6 input-polish font-hand" placeholder="Google Map é€£çµ" value="${item.mapUrl||''}"><div class="flex flex-col gap-3"><button onclick="savePlan()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">å„²å­˜</button>${id ? `<button onclick="deleteItem('plan', '${id}')" class="w-full py-3 text-red-400 font-bold mt-2 ${id?'':'hidden'} font-hand">åˆªé™¤æ­¤è¡Œç¨‹</button>` : ''}</div>`;
            } else if(type==='note') {
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">Edit Memo</h3><textarea id="note-text" class="w-full p-4 bg-yellow-50 rounded-2xl border-2 border-yellow-100 mb-4 input-polish text-sm h-40 resize-none font-hand" placeholder="å¯«é»ä»€éº¼...">${appData.note.text}</textarea><div class="mb-6"><div class="w-full h-40 bg-gray-100 rounded-2xl overflow-hidden mb-3 border-2 border-dashed border-gray-200 flex items-center justify-center relative"><img id="note-preview" src="${appData.note.img||''}" class="w-full h-full object-cover ${appData.note.img?'':'hidden'}"><div class="absolute text-gray-400 flex flex-col items-center pointer-events-none ${appData.note.img?'hidden':''}"><i class="fa-solid fa-camera text-2xl mb-1"></i><span class="text-xs font-hand">ä¸Šå‚³ç…§ç‰‡</span></div><input type="file" id="note-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewFileCompressed(this, 'note-preview')"></div></div><button onclick="saveNote()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">å„²å­˜</button>`;
            } else if(type==='shop') {
                const item = id ? appData.shopping.find(i=>i.id===id) : {text:'', img:''};
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">Shopping Item</h3><input type="hidden" id="shop-id" value="${id||''}"><input id="shop-text" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish font-hand" placeholder="å•†å“åç¨±" value="${item.text}"><div class="mb-6"><div class="w-full h-40 bg-gray-100 rounded-2xl overflow-hidden mb-3 border-2 border-dashed border-gray-200 flex items-center justify-center relative"><img id="shop-preview" src="${item.img||''}" class="w-full h-full object-cover ${item.img?'':'hidden'}"><div class="absolute text-gray-400 flex flex-col items-center pointer-events-none ${item.img?'hidden':''}"><i class="fa-solid fa-camera text-2xl mb-1"></i><span class="text-xs font-hand">ä¸Šå‚³ç…§ç‰‡</span></div><input type="file" id="shop-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewFileCompressed(this, 'shop-preview')"></div></div><button onclick="saveShop()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">å„²å­˜</button><button onclick="deleteItem('shop', '${id}')" class="w-full py-3 text-red-400 font-bold mt-2 ${id?'':'hidden'} font-hand">åˆªé™¤</button>`;
            } else if(type==='wallet') {
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">Add Expense</h3><input id="exp-title" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish font-hand" placeholder="æ¶ˆè²»é …ç›®"><input id="exp-amount" type="number" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish text-lg font-hand" placeholder="é‡‘é¡ (JPY)"><select id="exp-type" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-6 input-polish appearance-none font-hand"><option value="FOOD">é£²é£Ÿ</option><option value="TRANSPORT">äº¤é€š</option><option value="SHOPPING">è³¼ç‰©</option><option value="HOTEL">ä½å®¿</option><option value="OTHER">å…¶ä»–</option></select><button onclick="saveExpense()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">æ–°å¢æ¶ˆè²»</button>`;
            } else if(type==='info') {
                const item = id ? appData.vouchers.find(v=>v.id===id) : {title:'', text:'', type:'HOTEL', img:''};
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">Voucher</h3><input type="hidden" id="vou-id" value="${id||''}"><div class="flex gap-3 mb-4"><input id="vou-title" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 input-polish font-hand" placeholder="æ†‘è­‰æ¨™é¡Œ" value="${item.title}"><select id="vou-type" class="p-4 bg-white rounded-2xl border-2 border-gray-100 w-1/2 input-polish appearance-none font-hand"><option value="HOTEL" ${item.type==='HOTEL'?'selected':''}>ä½å®¿</option><option value="TRANSPORT" ${item.type==='TRANSPORT'?'selected':''}>äº¤é€š</option><option value="FOOD" ${item.type==='FOOD'?'selected':''}>é¤å»³</option><option value="OTHER" ${item.type==='OTHER'?'selected':''}>å…¶ä»–</option></select></div><textarea id="vou-text" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-4 input-polish text-sm h-24 resize-none font-hand" placeholder="å‚™è¨»äº‹é …...">${item.text||''}</textarea><div class="mb-6"><div class="w-full h-40 bg-gray-100 rounded-2xl overflow-hidden mb-3 border-2 border-dashed border-gray-200 flex items-center justify-center relative"><img id="vou-preview" src="${item.img||''}" class="w-full h-full object-cover ${appData.note.img?'':'hidden'}"><div class="absolute text-gray-400 flex flex-col items-center pointer-events-none ${appData.note.img?'hidden':''}"><i class="fa-solid fa-camera text-2xl mb-1"></i><span class="text-xs font-hand">ä¸Šå‚³ç…§ç‰‡</span></div><input type="file" id="vou-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewFileCompressed(this, 'vou-preview')"></div></div><button onclick="saveVoucher()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">å„²å­˜</button>${id ? `<button onclick="deleteItem('info', '${id}')" class="w-full py-3 text-red-400 font-bold mt-2 ${id?'':'hidden'} font-hand">åˆªé™¤æ†‘è­‰</button>` : ''}`;
            } else if(type==='budget') {
                html = `<h3 class="text-center font-bold text-xl mb-6 text-theme-dark font-hand">è¨­å®šç¸½é ç®—</h3><input id="budget-in" type="number" class="w-full p-4 bg-white rounded-2xl border-2 border-gray-100 mb-6 input-polish text-lg font-hand" placeholder="é‡‘é¡ (JPY)" value="${appData.budget}"><button onclick="saveBudget()" class="w-full py-4 bg-theme-dark text-white rounded-2xl font-bold btn-hard text-lg font-hand">å„²å­˜è¨­å®š</button>`;
            }
            sheetContent.innerHTML = html;
            overlay.classList.remove('hidden'); setTimeout(()=>overlay.classList.remove('opacity-0'),10); sheet.classList.remove('translate-y-full');
        }
        function closeSheet() { sheet.classList.add('translate-y-full'); overlay.classList.add('opacity-0'); setTimeout(()=>overlay.classList.add('hidden'),300); }
        function initSwipeToDismiss() { const h=document.getElementById('sheet-handle'), s=document.getElementById('edit-sheet'); let sy=0, cy=0; h.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;s.style.transition='none';}); h.addEventListener('touchmove',e=>{cy=e.touches[0].clientY; const d=cy-sy; if(d>0)s.style.transform=`translateY(${d}px)`;}); h.addEventListener('touchend',e=>{s.style.transition='transform 0.3s ease'; const d=cy-sy; if(d>100)closeSheet(); else s.style.transform='';}); }
        
        // **IMPORTANT: Removed manual rendering (e.g., renderPlan()) after saveData(), as Firebase onSnapshot handles it.**
        function savePlan() { 
            const id=document.getElementById('form-id').value, tags=document.getElementById('form-tags').value?document.getElementById('form-tags').value.split(/,|ï¼Œ/).map(t=>t.trim()).filter(Boolean):[], tasksLines=document.getElementById('form-tasks').value?document.getElementById('form-tasks').value.split('\n').filter(t=>t.trim()):[]; 
            let oldTasks=[]; if(id){const old=appData.itinerary.find(i=>i.id==id);if(old)oldTasks=old.tasks||[];} 
            const tasks=tasksLines.map(text=>{const existing=oldTasks.find(t=>t.text===text);return{text,done:existing?existing.done:false};}); 
            const form={day:appData.currentDay,time:document.getElementById('form-time').value,type:document.getElementById('form-type').value,title:document.getElementById('form-title').value,duration:document.getElementById('form-duration').value,budget:document.getElementById('form-budget').value,travelTime:document.getElementById('form-travel').value,mapUrl:document.getElementById('form-map').value,tags,tasks}; 
            if(id){const idx=appData.itinerary.findIndex(i=>i.id==id);if(idx>-1)appData.itinerary[idx]={...appData.itinerary[idx],...form};}else appData.itinerary.push({id:Date.now(),...form}); 
            saveData(); 
            closeSheet(); 
        }
        function saveNote() { 
            const text=document.getElementById('note-text').value, preview=document.getElementById('note-preview'), img=preview.src&&!preview.classList.contains('hidden')?preview.src:null; 
            appData.note = {text, img}; 
            saveData(); 
            closeSheet(); 
        }
        function saveShop() { 
            const id=document.getElementById('shop-id').value, text=document.getElementById('shop-text').value, preview=document.getElementById('shop-preview'), img=preview.src&&!preview.classList.contains('hidden')?preview.src:null; 
            if(id){const idx=appData.shopping.findIndex(i=>i.id==id);if(idx>-1)appData.shopping[idx]={...appData.shopping[idx], text, img};}else appData.shopping.push({id:Date.now(), text, img, checked:false}); 
            saveData(); 
            closeSheet(); 
        }
        function deleteItem(type, id) { 
            if(!id) return; 
            if(type==='shop') appData.shopping=appData.shopping.filter(i=>i.id!=id); 
            if(type==='plan') appData.itinerary=appData.itinerary.filter(i=>i.id!=id); 
            if(type==='info') appData.vouchers=appData.vouchers.filter(v=>v.id!=id); 
            saveData(); 
            closeSheet(); 
        }
        function saveExpense() { 
            const t=document.getElementById('exp-title').value, a=document.getElementById('exp-amount').value, ty=document.getElementById('exp-type').value; 
            if(t&&a) { 
                appData.expenses.push({id:Date.now(), title:t, amount:a, type:ty}); 
                saveData(); 
                closeSheet(); 
            } 
        }
        async function saveVoucher() { 
            const id=document.getElementById('vou-id').value, t=document.getElementById('vou-title').value, ty=document.getElementById('vou-type').value, txt=document.getElementById('vou-text').value, preview=document.getElementById('vou-preview'), f=document.getElementById('vou-file').files[0]; 
            // æª¢æŸ¥æ¨™é¡Œæ˜¯å¦ç‚ºç©º
            if (!t || t.trim() === '') {
                Swal.fire('è¼¸å…¥éŒ¯èª¤', 'æ†‘è­‰å¿…é ˆå¡«å¯«æ¨™é¡Œï¼', 'warning');
                return;
            }

            let img = preview.src && !preview.classList.contains('hidden') ? preview.src : null; 
            if(f) img = await compressImage(f); 
            
            if(id) { 
                const idx=appData.vouchers.findIndex(v=>v.id==id); 
                if(idx>-1) appData.vouchers[idx]={...appData.vouchers[idx], title:t, type:ty, text:txt, img}; 
            } else { 
                appData.vouchers.push({id:Date.now(), title:t, type:ty, text:txt, img}); 
            } 
            
            saveData(); 
            closeSheet(); 
        }
        function saveBudget() { 
            const v=document.getElementById('budget-in').value; 
            if(v){ 
                appData.budget=parseInt(v); 
                saveData(); 
                closeSheet(); 
            } 
        }

        function initHeader() {
            const container = document.getElementById('date-scroll'); let html = '';
            for(let i=1; i<=9; i++) {
                const d = new Date(START_DATE); d.setDate(d.getDate()+i-1);
                const active = appData.currentDay===(i);
                const style = active ? 'date-btn-active' : 'opacity-60 grayscale';
                html += `<button onclick="switchDay(${i})" class="snap-start shrink-0 w-16 h-16 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 backdrop-blur-md ${style}"><span class="text-[10px] font-mono opacity-80 uppercase tracking-widest font-hand">Day ${i}</span><span class="font-serif text-xl font-bold leading-none mt-1 font-hand">${d.getMonth()+1}/${d.getDate()}</span></button>`;
            }
            container.innerHTML = html;
        }
        function switchDay(n) { appData.currentDay=n; initHeader(); if(currentView==='plan') renderPlan(); if(currentView==='map') renderMap(); }
        
        // --- Share Function Definition (FIXED) ---
        function shareItinerary() {
            const el = document.getElementById('plan-list');
            if(!el || el.children.length === 0) { Swal.fire('æç¤º', 'ä»Šå¤©æ²’æœ‰è¡Œç¨‹å¯ä»¥åŒ¯å‡ºå“¦ï¼', 'info'); return; }
            const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
            toast.fire({ icon: 'success', title: 'æ­£åœ¨ç”Ÿæˆç¾åœ–...' });
            html2canvas(el, { backgroundColor: '#FFFDF5', scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); 
                link.download = `Day${appData.currentDay}_Itinerary.png`; 
                link.href = canvas.toDataURL(); 
                link.click();
            }).catch(err => { 
                console.error(err); 
                Swal.fire('åŒ¯å‡ºå¤±æ•—', 'ç”Ÿæˆåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
            });
        }
        // ------------------------------------

        // --- Map Locate Function Definition ---
        function locateMe() {
            if(!mapInstance) return;
            if(!navigator.geolocation) { Swal.fire('éŒ¯èª¤', 'ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'error'); return; }
            const toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 2000 });
            toast.fire({ icon: 'info', title: 'æ­£åœ¨å®šä½ä¸­...' });
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude} = pos.coords;
                mapInstance.setView([latitude, longitude], 15);
                L.marker([latitude, longitude], {icon: L.divIcon({className: 'my-loc', html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-md relative"><div class="absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-75"></div></div>', iconSize: [16,16]})}).addTo(mapInstance).bindPopup("ç›®å‰ä½ç½®").openPopup();
            }, err => { Swal.fire('ç„¡æ³•å®šä½', 'è«‹ç¢ºèªå·²é–‹å•Ÿ GPS æ¬Šé™', 'error'); });
        }
        // ------------------------------------

        // --- Fetch Live Rate Function Definition (FIXED) ---
        async function fetchLiveRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                if(!res.ok) throw new Error('API Error');
                const data = await res.json();
                if(data && data.rates && data.rates.TWD) {
                    if(appData.isLiveRate !== false) {
                        appData.rate = data.rates.TWD; 
                        appData.isLiveRate = true; 
                        saveData(true); 
                    }
                }
            } catch(e) { 
                console.log('Rate fetch failed:', e); 
            }
        }
        // --------------------------------------------------

        // --- GLOBAL BINDINGS ---
        window.router = router;
        window.toggleCard = toggleCard;
        window.openEdit = openEdit;
        window.toggleTask = toggleTask;
        window.toggleComplete = toggleComplete;
        window.openGuide = openGuide;
        window.closeGuide = closeGuide;
        window.handleFabClick = handleFabClick;
        window.toggleShop = toggleShop;
        window.toggleCity = toggleCity;
        window.changeRate = changeRate;
        window.runCalc = runCalc;
        window.exportData = exportData;
        window.performRestore = performRestore;
        window.previewFileCompressed = previewFileCompressed;
        window.savePlan = savePlan;
        window.saveShop = saveShop;
        window.saveExpense = saveExpense;
        window.saveVoucher = saveVoucher;
        window.saveNote = saveNote;
        window.saveBudget = saveBudget;
        window.deleteItem = deleteItem;
        window.closeSheet = closeSheet;
        window.switchDay = switchDay;
        window.toggleDayGrid = toggleDayGrid;
        window.toggleMapFilter = toggleMapFilter;
        window.locateMe = locateMe; 
        window.shareItinerary = shareItinerary;
        window.fetchLiveRate = fetchLiveRate;
        window.showImageFullscreen = showImageFullscreen; // NEW: Global binding for fullscreen image viewer

    </script>
</body>
</html>
